<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦å²¡ä¹‹æ—… | Fukuoka Trip</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #D6EAF8; margin: 0; padding-bottom: 100px; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.3); }
        .curved-header { border-radius: 0 0 40px 40px; overflow: hidden; position: relative; height: 220px; background: white; }
        .banner-img { width: 100%; height: 100%; object-fit: cover; }
        .content-up { margin-top: -60px; position: relative; z-index: 20; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .modal-overlay { background: rgba(0, 0, 0, 0.5); position: fixed; inset: 0; z-index: 100; display: flex; align-items: end; justify-content: center; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 32px 32px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; }
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen relative">
        
        <header class="curved-header shadow-lg">
            <img src="IMG_0144.JPG" alt="Banner" class="banner-img" onerror="this.src='https://placehold.co/800x400?text=Fukuoka+Trip'">
            <div class="absolute bottom-16 right-4 flex space-x-2 bg-white/80 backdrop-blur-md p-1.5 rounded-2xl shadow-xl">
                <button v-for="tab in tabs" @click="activeTab = tab.id" :class="activeTab === tab.id ? 'text-blue-500' : 'text-gray-400'" class="p-2 transition-colors">
                    <i :data-lucide="tab.icon"></i>
                </button>
            </div>
        </header>

        <main class="content-up px-4">
            <div v-if="activeTab === 'itinerary'">
                <div class="flex space-x-3 overflow-x-auto hide-scrollbar py-4">
                    <div v-for="day in dates" @click="selectedDate = day.date" 
                         :class="selectedDate === day.date ? 'bg-blue-500 text-white shadow-lg' : 'bg-white/90 text-gray-500'" 
                         class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer border border-white/40">
                        <span class="text-[10px] font-black uppercase">{{ day.weekday }}</span>
                        <span class="text-xl font-bold">{{ day.dayNum }}</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-for="(item, index) in sortedItinerary" :key="item.id">
                        
                        <div v-if="index > 0" class="flex flex-col items-center py-2 text-blue-400 opacity-60">
                            <div class="flex items-center space-x-2 my-1">
                                <i :data-lucide="getTransportIcon(item.transport)" class="w-3 h-3"></i>
                                <span class="text-[10px] font-bold">é ä¼°äº¤é€š {{ calculateTravelTime(sortedItinerary[index-1], item) }} åˆ†é˜</span>
                            </div>
                        </div>

                        <div v-if="item.category === 'èˆªç­'" class="bg-gradient-to-br from-blue-600 to-blue-400 text-white p-5 rounded-[32px] shadow-lg relative" @click="openEditModal(item)">
                            <div class="flex justify-between items-center mb-3 text-[10px] font-bold">
                                <span>{{ item.name }}</span>
                                <span class="bg-white/20 px-2 py-0.5 rounded">{{ item.flightNo }}</span>
                            </div>
                            <div class="flex justify-between items-center text-center">
                                <div><h3 class="text-2xl font-black">TPE</h3><p class="text-xs">{{ item.time }}</p></div>
                                <i data-lucide="plane" class="w-5 h-5 rotate-90 opacity-50"></i>
                                <div><h3 class="text-2xl font-black">FUK</h3><p class="text-xs">{{ item.arrTime }}</p></div>
                            </div>
                        </div>

                        <div v-else class="glass-card p-5 relative shadow-sm border border-white active:scale-[0.98] transition-all" @click="openEditModal(item)">
                            <div class="flex justify-between items-start">
                                <span class="text-[9px] bg-blue-50 text-blue-500 px-2 py-0.5 rounded-full font-black uppercase">{{ item.category }}</span>
                                <i data-lucide="edit-3" class="w-4 h-4 text-gray-300"></i>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg mt-1">{{ item.name }}</h3>
                            
                            <div class="flex items-center justify-between mt-3">
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-gray-400">æŠµé”æ™‚é–“</span>
                                    <span class="text-sm font-bold text-gray-700">{{ item.time }}</span>
                                </div>
                                <div class="flex flex-col items-center px-4">
                                    <span class="text-[10px] text-blue-400 font-bold">åœç•™ {{ item.stay }}m</span>
                                    <div class="w-12 border-t border-gray-100 my-1"></div>
                                </div>
                                <div class="flex flex-col items-end">
                                    <span class="text-[10px] text-gray-400">é è¨ˆé›¢é–‹</span>
                                    <span class="text-sm font-bold text-blue-600">{{ calculateEndTime(item) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'info'" class="space-y-4 py-4">
                <div v-for="info in infoList" :key="info.id" class="glass-card p-5 border border-white" @click="openEditModal(info)">
                    <h4 class="font-bold text-gray-800 flex items-center"><i data-lucide="info" class="w-4 h-4 mr-2 text-blue-400"></i>{{ info.title }}</h4>
                    <p class="text-sm text-gray-500 mt-2 whitespace-pre-line leading-relaxed">{{ info.content }}</p>
                </div>
            </div>

            <div v-if="activeTab === 'expenses'" class="space-y-3 py-4">
                <div class="bg-blue-600 rounded-[32px] p-6 text-white mb-6">
                    <p class="text-xs opacity-70 mb-1 font-bold">Total Budget (JPY)</p>
                    <h2 class="text-4xl font-bold">Â¥ {{ totalExpenses.toLocaleString() }}</h2>
                </div>
                <div v-for="ex in expenses" :key="ex.id" class="glass-card p-4 flex justify-between items-center" @click="openEditModal(ex)">
                    <p class="font-bold text-gray-800">{{ ex.name }}</p>
                    <p class="font-bold text-red-500">Â¥ {{ Number(ex.amount).toLocaleString() }}</p>
                </div>
            </div>
        </main>

        <button @click="handlePlusBtn" class="fixed bottom-8 right-8 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center z-50">
            <i data-lucide="plus"></i>
        </button>

        <div v-if="showModal" class="modal-overlay" @click.self="showModal = false">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">{{ isEditing ? 'ä¿®æ”¹é …ç›®' : 'æ–°å¢' + activeTabName }}</h3>
                    <button v-if="isEditing" @click="handleDelete" class="text-red-500 text-xs font-bold bg-red-50 px-3 py-1 rounded-full">åˆªé™¤æ­¤é …</button>
                </div>

                <div class="space-y-4">
                    <template v-if="activeTab === 'itinerary'">
                        <input v-model="form.name" placeholder="åœ°é»æˆ–åç¨±" class="w-full bg-gray-100 rounded-2xl p-4 outline-none font-bold">
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] text-gray-400 ml-2">æŠµé”æ™‚é–“</label>
                                <input v-model="form.time" type="time" class="w-full bg-gray-100 rounded-2xl p-4 outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 ml-2">åœç•™æ™‚é–“ (åˆ†é˜)</label>
                                <input v-model.number="form.stay" type="number" class="w-full bg-gray-100 rounded-2xl p-4 outline-none">
                            </div>
                        </div>

                        <select v-model="form.category" @change="autoSetStayTime" class="w-full bg-gray-100 rounded-2xl p-4 outline-none">
                            <option value="æ™¯é»">æ™¯é» (é è¨­åœç•™ 90åˆ†)</option>
                            <option value="ç¾é£Ÿ">ç¾é£Ÿ (é è¨­åœç•™ 60åˆ†)</option>
                            <option value="è³¼ç‰©">è³¼ç‰© (é è¨­åœç•™ 120åˆ†)</option>
                            <option value="ä½å®¿">ä½å®¿ (é è¨­åœç•™ 30åˆ†)</option>
                            <option value="èˆªç­">èˆªç­</option>
                        </select>

                        <select v-model="form.transport" class="w-full bg-gray-100 rounded-2xl p-4 outline-none">
                            <option value="bus">ğŸšŒ å¤§çœ¾é‹è¼¸</option>
                            <option value="walk">ğŸš¶ å¾’æ­¥</option>
                            <option value="car">ğŸš• è¨ˆç¨‹è»Š/è‡ªé§•</option>
                        </select>
                    </template>

                    <template v-if="activeTab === 'info'">
                        <input v-model="form.title" placeholder="æ¨™é¡Œ" class="w-full bg-gray-100 rounded-2xl p-4 outline-none font-bold">
                        <textarea v-model="form.content" placeholder="å…§å®¹" class="w-full bg-gray-100 rounded-2xl p-4 outline-none h-32"></textarea>
                    </template>
                    <template v-if="activeTab === 'expenses'">
                        <input v-model="form.name" placeholder="æ”¯å‡ºé …ç›®" class="w-full bg-gray-100 rounded-2xl p-4 outline-none font-bold">
                        <input v-model.number="form.amount" type="number" placeholder="é‡‘é¡ (JPY)" class="w-full bg-gray-100 rounded-2xl p-4 outline-none">
                    </template>
                </div>
                
                <button @click="handleSave" class="w-full bg-blue-600 text-white rounded-2xl py-4 mt-8 font-black shadow-lg">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        createApp({
            setup() {
                const activeTab = ref('itinerary');
                const selectedDate = ref('1/6');
                const showModal = ref(false);
                const isEditing = ref(false);
                const form = ref({});

                const tabs = [{id:'itinerary',icon:'map-pin',name:'è¡Œç¨‹'}, {id:'info',icon:'info',name:'è³‡è¨Š'}, {id:'expenses',icon:'banknote',name:'èŠ±è²»'}];
                const dates = [{weekday:'Mon',dayNum:'6',date:'1/6'}, {weekday:'Tue',dayNum:'7',date:'1/7'}, {weekday:'Wed',dayNum:'8',date:'1/8'}, {weekday:'Thu',dayNum:'9',date:'1/9'}];

                // è¼‰å…¥è³‡æ–™
                const itineraryItems = ref(JSON.parse(localStorage.getItem('fuk_itinerary')) || []);
                const infoList = ref(JSON.parse(localStorage.getItem('fuk_info')) || []);
                const expenses = ref(JSON.parse(localStorage.getItem('fuk_expenses')) || []);

                // ç›£è½è®Šå‹•
                watch(itineraryItems, (v) => localStorage.setItem('fuk_itinerary', JSON.stringify(v)), { deep: true });
                watch(infoList, (v) => localStorage.setItem('fuk_info', JSON.stringify(v)), { deep: true });
                watch(expenses, (v) => localStorage.setItem('fuk_expenses', JSON.stringify(v)), { deep: true });

                const activeTabName = computed(() => tabs.find(t => t.id === activeTab.value).name);
                const sortedItinerary = computed(() => itineraryItems.value.filter(i => i.date === selectedDate.value).sort((a,b) => a.time.localeCompare(b.time)));
                const totalExpenses = computed(() => expenses.value.reduce((s, i) => s + (Number(i.amount) || 0), 0));

                // --- æ ¸å¿ƒé‚è¼¯ï¼šæ™‚é–“è™•ç† ---
                const timeToMin = (t) => { if(!t) return 0; const [h,m] = t.split(':').map(Number); return h*60+m; };
                const minToTime = (m) => {
                    const h = Math.floor(m / 60) % 24;
                    const min = m % 60;
                    return `${String(h).padStart(2,'0')}:${String(min).padStart(2,'0')}`;
                };

                const calculateEndTime = (item) => {
                    if (item.category === 'èˆªç­') return item.arrTime;
                    const startMin = timeToMin(item.time);
                    return minToTime(startMin + (item.stay || 0));
                };

                const calculateTravelTime = (prev, curr) => {
                    const prevEndMin = timeToMin(calculateEndTime(prev));
                    const currStartMin = timeToMin(curr.time);
                    const diff = currStartMin - prevEndMin;
                    return diff > 0 ? diff : 10;
                };

                const autoSetStayTime = () => {
                    const preset = { 'æ™¯é»': 90, 'ç¾é£Ÿ': 60, 'è³¼ç‰©': 120, 'ä½å®¿': 30 };
                    if (preset[form.value.category]) form.value.stay = preset[form.value.category];
                };

                const handlePlusBtn = () => {
                    isEditing.value = false;
                    form.value = { category:'æ™¯é»', name:'', time:'12:00', stay:90, transport:'bus' };
                    showModal.value = true;
                };

                const openEditModal = (item) => {
                    isEditing.value = true;
                    form.value = { ...item };
                    showModal.value = true;
                };

                const handleSave = () => {
                    const listMap = { itinerary: itineraryItems, info: infoList, expenses: expenses };
                    const currentList = listMap[activeTab.value];
                    if(isEditing.value) {
                        const idx = currentList.value.findIndex(i => i.id === form.value.id);
                        if(idx !== -1) currentList.value[idx] = { ...form.value };
                    } else {
                        const newItem = { ...form.value, id: Date.now() };
                        if(activeTab.value === 'itinerary') newItem.date = selectedDate.value;
                        currentList.value.push(newItem);
                    }
                    showModal.value = false;
                    nextTick(() => lucide.createIcons());
                };

                const handleDelete = () => {
                    if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
                    const listMap = { itinerary: itineraryItems, info: infoList, expenses: expenses };
                    listMap[activeTab.value].value = listMap[activeTab.value].value.filter(i => i.id !== form.value.id);
                    showModal.value = false;
                };

                onMounted(() => lucide.createIcons());
                watch([activeTab, selectedDate, showModal], () => nextTick(() => lucide.createIcons()));

                return { activeTab, tabs, dates, selectedDate, sortedItinerary, infoList, expenses, totalExpenses, showModal, form, isEditing, activeTabName, handlePlusBtn, openEditModal, handleSave, handleDelete, calculateEndTime, calculateTravelTime, autoSetStayTime, getTransportIcon: (t) => ({walk:'walking', car:'car', bus:'bus'}[t] || 'bus') };
            }
        }).mount('#app');
    </script>
</body>
</html>
